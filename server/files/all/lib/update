-- vim: ft=lua

local function prnt(str, log)
	if log then
		print(str)
	end
end

local function download(fileId, currentVersion, log, address, device)
	prnt("id: " .. fileId, log)
	prnt("current version: " .. currentVersion, log)

	if address == nil then
		settings.load("data/serverData")
		address = settings.get("servers").main
	end
	if device == nil then
		settings.load("data/serverData")
		device = settings.get("device")
	end

	local fullFileId = ""
	if device == "" then
		fullFileId = fileId
	else
		fullFileId = device .. "/" .. fileId
	end

	prnt("connecting...", log)
	local ws = http.websocket(address)

	if ws then
		ws.send(os.getComputerLabel())
		ws.send("version")
		ws.send(fullFileId)
		prnt("getting newest version...", log)
		local version = ws.receive()
		if version ~= "goodbye" then
			prnt("newest version: " .. version, log)
			if version ~= currentVersion then
				ws.send("download")
				ws.send(device .. "/" .. fileId)

				local message = ws.receive()
				if message == nil then
					return false, "info json nil"
				end

				local info = textutils.unserialiseJSON(message, { parse_null = true })
				if info == nil then
					return false, "info json nil"
				end

				local paths = {}
				local data = {}
				while true do
					message = ws.receive()
					if message ~= "complete" then
						table.insert(data, message)
						local path = ws.receive()
						table.insert(paths, path)
						prnt("downloaded " .. path, log)
					else
						break
					end
				end

				if info["directories"] ~= nil then
					for _, path in pairs(info["directories"]) do
						fs.makeDir(path)
						prnt("making dir " .. path, log)
					end
				end
				prnt("installing...", log)

				for i = 1, #paths do
					local file = fs.open(paths[i], "w")
					if file ~= nil then
						file.write(data[i])
						file.close()
						prnt("installed " .. paths[i], log)
					else
						prnt("file was nil, folder doesnt exist?", log)
						return false, "file returned nil"
					end
				end
				settings.clear()
				settings.load("data/mirrors")
				settings.set(fileId, address)
				settings.save("data/mirrors")
				prnt("completed.", log)
				ws.send("close")
				prnt("disconnected", log)

				if info["requirements"] ~= nil then
					for _, req in pairs(info["requirements"]) do
						prnt("installing requirement " .. req, log)
						local success, reason = download(req, "nil", true, address, "")
						if success == false then
							return false, reason
						end
					end
				end

				return true, "success"
			else
				prnt("up to date.", log)
				ws.send("close")
				prnt("disconnected", log)
				return false, "up to date"
			end
		else
			prnt("failed: file doesnt exist", log)
			return false, "files doesnt exist"
		end
	else
		prnt("could not connect to server", log)
		return false, "couldnt connect to server"
	end
end

return {
	download = download,
}

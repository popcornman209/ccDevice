-- vim: ft=lua

local binds = {
	["up"] = 265,
	["down"] = 264,
	["enter"] = 257,
	["back"] = 259,
}

---@diagnostic disable-next-line: undefined-field
if os.about ~= nil then -- if using craft os pc emulator
	Binds = {
		["up"] = 200,
		["down"] = 208,
		["enter"] = 28,
		["back"] = 14,
	}
end

local function clear(title, bottomText) -- clear screen function, draws bars
	if bottomText == nil then
		bottomText = "(up/down/enter/backspace): navigate"
	end

	local resX, resY = term.getSize()

	term.setBackgroundColor(colors.black)
	term.clear()
	paintutils.drawBox(1, 1, resX, 1, colors.gray)
	term.setCursorPos(resX / 2 - #title / 2, 1)
	term.write(title)
	term.setCursorPos(1, resY)
	term.setBackgroundColor(colors.black)
	term.write(bottomText)
end

local function drawChoices(choices, choiceDetails, scroll, title) -- draws a list of choices, bout it
	clear(title)
	local resX, resY = term.getSize()
	for i = 1 + scroll, math.min(#choices, (resY - 4) + scroll) do
		term.setCursorPos(4, i + 2 - scroll)
		print(choices[i])
		if choiceDetails ~= nil then
			term.setCursorPos(resX / 2, i + 2 - scroll)
			print(choiceDetails[i])
		end
	end
end

local function getChoice(choices, choiceDetails, title) -- gets user inputs and lets you select different choices
	local cursorPos = 1
	local scroll = 0
	drawChoices(choices, choiceDetails, scroll, title)
	local _, resY = term.getSize()
	while true do
		paintutils.drawBox(2, 3, 2, resY - 2)
		term.setCursorPos(2, cursorPos + 2 - scroll)
		print(">")
		local _, key = os.pullEvent("key")
		if key == Binds["up"] then
			cursorPos = math.max(cursorPos - 1, 1)
			if cursorPos < 1 + scroll then
				scroll = scroll - 1
				drawChoices(choices, choiceDetails, scroll, title)
			end
		elseif key == Binds["down"] then
			cursorPos = math.min(cursorPos + 1, #choices)
			if cursorPos > (resY - 4) + scroll then
				scroll = scroll + 1
				drawChoices(choices, choiceDetails, scroll, title)
			end
		elseif key == Binds["enter"] then
			return cursorPos
		elseif key == Binds["back"] then
			return nil
		end
	end
end

local function input(text, bottomText, title)
	clear(title, bottomText)
	term.setCursorPos(2, 3)
	print(text)
	term.setCursorPos(2, 4)
	return read()
end

return {
	binds = binds,
	clear = clear,
	drawChoices = drawChoices,
	getChoice = getChoice,
	input = input,
}

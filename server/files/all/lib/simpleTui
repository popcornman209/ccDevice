-- vim: ft=lua

local binds = { -- key index numbers, what os.pullEvent("key") would return
	["up"] = 265,
	["down"] = 264,
	["enter"] = 257,
	["back"] = 259,
}

---@diagnostic disable-next-line: undefined-field
if os.about ~= nil then -- if using craft os pc emulator (normal cc:tweaked doesnt have os.about as far as i know)
	binds = { -- change keybinds to match, they seem to be different on the emulator
		["up"] = 200,
		["down"] = 208,
		["enter"] = 28,
		["back"] = 14,
	}
end

local function clear(title, bottomText) -- clear screen function, draws bars
	if bottomText == nil then
		bottomText = "(up/down/enter/backspace): navigate"
	end

	local resX, resY = term.getSize()

	term.setBackgroundColor(colors.black)
	term.clear() -- clear screen
	paintutils.drawBox(1, 1, resX, 1, colors.gray) -- gray top bar
	term.setCursorPos(resX / 2 - #title / 2, 1)
	term.write(title) -- write title in center of screen
	term.setCursorPos(1, resY) -- move cursor to bottom left corner
	term.setBackgroundColor(colors.black)
	term.write(bottomText) -- write bottom text
end

local function drawChoices(choices, choiceDetails, scroll, title) -- draws a list of choices, bout it
	clear(title) -- clear screen
	local resX, resY = term.getSize()
	for i = 1 + scroll, math.min(#choices, (resY - 4) + scroll) do -- go through all choice indexes on screen
		term.setCursorPos(4, i + 2 - scroll) -- move cursor
		print(choices[i]) -- print the name of the choice
		if choiceDetails ~= nil then -- if it has a small description
			term.setCursorPos(resX / 2, i + 2 - scroll)
			print(choiceDetails[i]) -- print the description
		end
	end
end

local function getChoice(choices, choiceDetails, title) -- gets user inputs and lets you select different choices
	local cursorPos = 1
	local scroll = 0
	drawChoices(choices, choiceDetails, scroll, title) -- draw choices one time
	local _, resY = term.getSize()
	while true do
		paintutils.drawBox(2, 3, 2, resY - 2) -- clears any previous cursors
		term.setCursorPos(2, cursorPos + 2 - scroll) -- go to cursor position
		print(">") -- draw this showing which you have selected
		local _, key = os.pullEvent("key")
		if key == binds["up"] then
			cursorPos = math.max(cursorPos - 1, 1)
			if cursorPos < 1 + scroll then
				scroll = scroll - 1
				drawChoices(choices, choiceDetails, scroll, title) -- redraw
			end
		elseif key == binds["down"] then
			cursorPos = math.min(cursorPos + 1, #choices)
			if cursorPos > (resY - 4) + scroll then
				scroll = scroll + 1
				drawChoices(choices, choiceDetails, scroll, title) -- redraw
			end
		elseif key == binds["enter"] then -- item selected
			return cursorPos
		elseif key == binds["back"] then -- went back
			return nil
		end
	end
end

local function input(text, bottomText, title) -- get a text input
	clear(title, bottomText)
	term.setCursorPos(2, 3)
	print(text)
	term.setCursorPos(2, 4)
	return read()
end

return {
	binds = binds,
	clear = clear,
	drawChoices = drawChoices,
	getChoice = getChoice,
	input = input,
}

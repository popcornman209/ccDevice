-- vim: ft=lua

settings.clear()
if settings.load("data/nas") == false then
	error("no config found, run findChest in CraftOS to setup")
end
local mainChestName = settings.get("mainChest")
local ignoreChests = settings.get("ignore")
local mainChest = peripheral.wrap(mainChestName)

local chests = { peripheral.find("inventory") }

local mainChestID = nil
for i, chest in pairs(chests) do
	if peripheral.getName(chest) == mainChestName then
		mainChestID = i
	end
end
if mainChestID == nil then
	error("main chest not connected!")
end
table.remove(chests, mainChestID)

local function removeChest(list, item)
	for i, val in pairs(list) do
		if peripheral.getName(val) == item then
			table.remove(list, i)
		end
	end
end

for _, ignore in pairs(ignoreChests) do
	removeChest(chests, ignore)
end

local nasF = require("/modules/nasFunctions")
local sTui = require("/modules/simpleTui")

while 1 do
	local menuChoice = sTui.GetChoice({ "deposit", "withdraw", "view items", "search items" }, false, "CCDevice NAS")
	if menuChoice == 1 then
		sTui.Clear("enter to continue...", "Deposit")
		term.setCursorPos(2, 3)
		print("put items in the chest and press enter...")
		nasF.EnterToContinue()
		sTui.Clear("wait...", "Withdraw")
		term.setCursorPos(2, 3)
		print("loading...")
		---@diagnostic disable-next-line: need-check-nil
		for i, item in pairs(mainChest.list()) do
			local count = item["count"]
			local chest = 1
			while count > 0 and chest <= #chests do
				---@diagnostic disable-next-line: undefined-field
				count = count - chests[chest].pullItems(mainChestName, i)
				chest = chest + 1
			end
		end
	elseif menuChoice == 2 then
		local items = nasF.getItems()
		local search = sTui.Input("search for item:", "enter to continue...", "withdraw")
		local results = {}
		for item, _ in pairs(items) do
			if search ~= nil and string.find(item, search) then
				table.insert(results, item)
			end
		end
		if #results > 0 then
			local choice = getChoice(results, true, "Withdraw")
			if choice then
				sTui.Clear("enter to continue...", "Withdraw")
				term.setCursorPos(2, 3)
				print("choose amount to withdraw (max: " .. items[results[choice]] .. ")")
				term.setCursorPos(2, 4)
				local amount = tonumber(read())
				if amount == nil then
					amount = 0
				end
				if amount < 0 then
					amount = 0
				elseif amount > items[results[choice]] then
					amount = items[results[choice]]
				end
				local chest = 1
				sTui.Clear("wait...", "Withdraw")
				term.setCursorPos(2, 3)
				print("loading...")
				local chestContents = nasF.GetChestContents()
				while amount > 0 do
					local chestContent = chestContents[chest]
					for i, item in pairs(chestContent) do
						if item["name"] == results[choice] then
							---@diagnostic disable-next-line: undefined-field
							amount = amount - chests[chest].pushItems(mainChestName, i, amount)
						end
					end
					chest = chest + 1
				end
			end
		else
			sTui.Clear("wait...", "Withdraw")
			term.setCursorPos(2, 3)
			print("no items found!")
			os.sleep(1)
		end
	elseif menuChoice == 3 then
		local itemList = {}
		local items = nasF.GetItems()
		for item, _ in pairs(items) do
			table.insert(itemList, item)
		end
		repeat
			local choice = sTui.GetChoice(itemList, true, "item list")
			if choice then
				sTui.Clear("enter to continue...", "item list")
				term.setCursorPos(2, 3)
				print("item name: " .. itemList[choice])
				print(" item count: " .. items[itemList[choice]])
				nasF.EnterToContinue()
			end
		until choice == false
	elseif menuChoice == 4 then
		local items = nasF.GetItems()
		repeat
			sTui.Clear("enter to continue...", "Search")
			term.setCursorPos(2, 3)
			print("search for item ('quit' to leave):")
			term.setCursorPos(2, 4)
			local search = read()
			if search ~= "quit" then
				local results = {}
				for item, _ in pairs(items) do
					if string.find(item, search) then
						table.insert(results, item)
					end
				end
				if #results > 0 then
					local choice = getChoice(results, true, "Search")
					if choice then
						sTui.Clear("enter to continue...", "item list")
						term.setCursorPos(2, 3)
						print("item name: " .. results[choice])
						print(" item count: " .. items[results[choice]])
						nasF.EnterToContinue()
					end
				else
					sTui.Clear("wait...", "Search")
					term.setCursorPos(2, 3)
					print("no items found!")
					os.sleep(1)
				end
			end
		until search == "quit"
	end
end

-- vim: ft=lua

local title = "Device Receiver Setttings"

local sNet = require("/lib/secureNet")
local sTui = require("/lib/simpleTui")

local function changeHostname()
	local key = false
	local hostname = ""
	while key == false do
		hostname = sTui.input("hostname: ", "type a string", title)
		key, _ = sNet.registerStaticAddress(hostname)
		if key == false then
			sTui.clear(title, "wait 3 seconds...")
			term.setCursorPos(2, 3)
			print("failed, hostname already in use or invalid?")
			os.sleep(3)
		end
	end
	settings.set("hostName", hostname)
	settings.set("key", key)
end
local function changeReceiver()
	settings.set("receiver", sTui.input("receiver: ", "type a string", title))
end
local function changePassword()
	settings.set("password", sTui.input('password ("" for none): ', "type a string", title))
end
local function changeChannel()
	settings.set("channel", sTui.input('channel ("" for private): ', "type a string", title))
end
local function changeSide()
	settings.set("redstone side", sTui.input("side to activate: ", "type a string", title))
end

local settingsList = {
	"hostName",
	"receiver",
	"password",
	"channel",
	"redstone side",
}
local functionList = {
	changeHostname,
	changeReceiver,
	changePassword,
	changeChannel,
	changeSide,
}

settings.clear()
if fs.exists("data/deviceRemote") then
	settings.load("data/deviceRemote")
end

for i = 1, #settingsList do
	if settings.get(settingsList[i]) == nil then
		functionList[i]()
	end
end

table.insert(settingsList, 1, "save and reboot")
while true do
	local choice = sTui.getChoice(settingsList, nil, title)
	if choice == 1 then
		settings.save("data/deviceRemote")
		os.reboot()
	else
		functionList[choice - 1]()
	end
end

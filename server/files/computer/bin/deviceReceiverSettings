-- vim: ft=lua

local title = "Device Receiver Setttings"

local sNet = require("/modules/secureNet")
local sTui = require("/modules/simpleTui")

local hostname = ""

local function changeHostname()
	local key = false
	while key == false do
		hostname = sTui.Input("hostname: ", "type a string", title)
		key, _ = sNet.registerStaticAddress(hostname)
		if key == false then
			sTui.Clear("wait 3 seconds...")
			term.setCursorPos(2, 3)
			print("failed, hostname already in use or invalid?")
			os.sleep(3)
		end
	end
	settings.set("hostName", hostname)
	settings.set("key", key)
end
local function changeDispName()
	settings.set("dispName", sTui.Input("display name: ", "type a string"))
end
local function changePassword()
	settings.set("password", sTui.Input('password ("" for none): ', "type a string"))
end
local function changeChannel()
	settings.set("channel", sTui.Input('channel ("" for private): ', "type a string"))
end
local function changeSide()
	settings.set("redstone side", sTui.Input("side to activate: ", "type a string"))
end
local function changeMode()
	local mode = sTui.Input("mode ('toggle' or #secs to hold>):", "type a 'toggle' or a number")
	if mode ~= "toggle" then
		mode = tonumber(mode)
	end
	if mode ~= nil then
		settings.set("mode", mode)
	end
end

local settingsList = {
	"hostName",
	"dispName",
	"password",
	"channel",
	"redstone side",
	"mode",
}
local functionList = {
	changeHostname,
	changeDispName,
	changePassword,
	changeChannel,
	changeSide,
	changeMode,
}

settings.clear()
if fs.exists("data/deviceReceiver") then
	settings.load("data/deviceReceiver")
end

for i = 1, #settingsList do
	if settings.get(settingsList[i]) == nil then
		functionList[i]()
	end
end

table.insert(settingsList, 1, "save and reboot")
while true do
	local choice = sTui.GetChoice(settingsList)
	if choice == 1 then
		settings.save("data/deviceReceiver")
		os.reboot()
	else
		functionList[choice - 1]()
	end
end
